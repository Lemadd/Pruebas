@model ProyectoWeb.Models.tb_funcion
@{
    ViewBag.Title = "AgregarCartelera";
}

<h2 class="azul">Agregar Cartelera</h2>

@using (Html.BeginForm("AgregarCartelera", "Cartelera", FormMethod.Post, new { @class = "form-horizontal", @role = "form" }))
{
    <div class="row">
        <div class="col-md-5">
            <div class="form-group">
                <label class="control-label col-sm-4 azul">Codigo</label>
                <div class="col-sm-8">
                    @Html.TextBoxFor(Model => Model.cod_funcion, new { @Value = ViewBag.codigo, @readonly = "readonly", @class = "form-control", @hidden = "true" })
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-5">
            <div class="form-group">
                <label class="control-label col-sm-4 azul">Local</label>
                <div class="col-sm-8">
                    @Html.DropDownList("id_local", (SelectList)ViewBag.locales, "Elija Local", new { @class = "form-control", @id = "locales" })
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="form-group">
                <div class="control-label">
                    <input class="btn btn-primary btn-lg" type="submit" value="GRABAR" />
                </div>
            </div>
        </div>
    </div>
    <hr />
    <div class="row">
        <div class="col-md-5">
            <div class="form-group">
                <label class="control-label col-sm-4 azul">Salas</label>
                <div class="col-sm-8">
                    <select id="salas" name="cod_sala" class="form-control">
                        <option value="-1">Elija Sala</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="form-group">
                <label class="control-label col-sm-4">Pelicula</label>
                <div class="col-sm-8">
                    @Html.DropDownList("cod_peli", (SelectList)ViewBag.peliculas, new { @class = "form-control" })
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-5">
            <div class="form-group">
                <label class="control-label col-sm-4 azul">Fecha de Inicio</label>
                <div class="col-sm-8">
                    <div class='input-group date azul' id='datetimepicker2a'>
                        <input type='text' name="fecha_inicio" class="form-control azul" />
                        <span class="input-group-addon">
                            <span class="glyphicon glyphicon-calendar azul"></span>
                        </span>
                    </div>
                    <script type="text/javascript">
                        $(function () {
                            $('#datetimepicker2a').datetimepicker({
                                locale: 'es',
                                format: 'L'
                            });
                        });
                    </script>
                    @Html.ValidationMessageFor(Model => Model.fecha_inicio)
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="form-group">
                <label class="control-label col-sm-4 azul">Fecha de Fin</label>
                <div class="col-sm-8">
                    <div class='input-group date azul' id='datetimepicker2b'>
                        <input type='text' name="fecha_fin" class="form-control" />
                        <span class="input-group-addon form azul">
                            <span class="glyphicon glyphicon-calendar"></span>
                        </span>
                    </div>
                    <script type="text/javascript">
                        $(function () {
                            $('#datetimepicker2b').datetimepicker({
                                locale: 'es',
                                format: 'L'
                            });
                        });
                    </script>
                    @Html.ValidationMessageFor(Model => Model.fecha_fin)
                </div>
            </div>
        </div>
    </div>
}
<br />

<div class="row" style="margin-left:50px;margin-right:50px;">
    <div class="col-md-12">
        <h3 class="azul">Asigne horas de funcion</h3>
        <fieldset>
            <div class="col-md-4 col-md-offset-1">
                <div class="form-group">
                    <label class="control-label col-sm-4 azul">Dia</label>
                    <div class="col-md-8">
                        @Html.ListBox("id_dia", (SelectList)ViewBag.dias, new { @class = "form-control azul",@id = "cboDias" })
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-md-offset-1">
                <div class="form-group">
                    <label class="control-label col-sm-4 azul">Hora de Inicio</label>
                    <div class="col-sm-8">
                        <div class='input-group date azul' id='datetimepicker2c'>
                            <input type='text' name="hora_inicio" class="form-control azul" id="txtHoraInicio" />
                            <span class="input-group-addon">
                                <span class="glyphicon glyphicon-time"></span>
                            </span>
                        </div>
                        <script type="text/javascript">
                            $(function () {
                                $('#datetimepicker2c').datetimepicker({
                                    format: 'HH:mm'
                                });
                            });
                        </script>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="control-label col-sm-2">
                    <button class="btn btn-default" type="button" id="btnAnadir">Añadir</button>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div>
                        <strong class="azul">LUNES:</strong>
                        <p id="1"></p>
                    </div>
                    <div>
                        <strong class="azul">MARTES:</strong>
                        <p id="2"></p>
                    </div>
                    <div>
                        <strong class="azul">MIERCOLES:</strong>
                        <p id="3"></p>
                    </div>
                    <div>
                        <strong class="azul">JUEVES:</strong>
                        <p id="4"></p>
                    </div>
                    <div>
                        <strong class="azul">VIERNES:</strong>
                        <p id="5"></p>
                    </div>
                    <div>
                        <strong class="azul">SABADO:</strong>
                        <p id="6"></p>
                    </div>
                    <div>
                        <strong class="azul">DOMINGO:</strong>
                        <p id="7"></p>
                    </div>
                </div>
            </div>
        </fieldset>
    </div> 
</div>


<script>

    $(document).ready(function () {

        $("form #locales").change(function () {
            console.log("asd");
            var locales = document.getElementById("locales");
            var codLocal = locales.options[locales.selectedIndex].value;

            $("#salas").get(0).options.length = 0;
            $("#salas").get(0).options[0] = new Option("Elija Sala", "-1");

            if (codLocal == -1) {
                return;
            }

            $.ajax({
                type: "GET",
                url: "@Url.Action("SalasDisponibles", "Cartelera")",
                data: "idLocal=" + codLocal,
                dataType: "json",
                success: function (data) {
                    console.log(data);

                    $("#salas").get(0).options.length = 0;
                    $("#salas").get(0).options[0] = new Option("Elija Sala", "-1");

                    $.each(data, function (index, item) {
                        $("#salas").get(0).options[$("#salas").get(0).options.length] = new Option(item.nom_sala,item.cod_sala);
                    });
                },
                error: function (error) {
                    console.log(error);
                    $("#salas").get(0).options.length = 0;

                }
            });
        });

        $("#btnAnadir").click(function () {

            if (document.getElementById("txtHoraInicio").value.trim() === "") {
                return;
            }

            agregarHorario();
        });

        $("button[name=horario]").on("click", function (event) {
            console.log("1")
            var horarioFuncion = {};

            var id = $(this).attr("id");
            arrayID = id.split("_");
            horarioFuncion.id_dia = arrayID[1];
            horarioFuncion.hora_inicio = arrayID[0];

            $.ajax({
                contentType: 'application/json; charset=utf-8',
                type: "POST",
                dataType: 'json',
                url: "@Url.Action("EliminarHorarioFuncion", "Cartelera")",
                data: horarioFuncion,
                success: function (data) {
                
                    for (var i = 1; i <= 7; i++) {
                        var p = document.getElementById(i);
                        p.innerHTML = "";
                    }

                    for (var i = 0; i < data.length; i++) {
                        var p = document.getElementById(data[i].id_dia);
                        p.innerHTML = p.innerHTML + ", " + data[i].hora_inicio;
                    }
                },
                error: function (error) {
                    console.log(error);
                }
            });
        });

    });

    function agregarHorario() {

        var listahorarios = [];
        var cboDias = document.getElementById("cboDias"); 

        for (x = 0; x < cboDias.length; x++) {
            if (cboDias[x].selected) {
                var tb_horarios_funcionDTO = {};
                tb_horarios_funcionDTO.id_dia = cboDias[x].value ;
                tb_horarios_funcionDTO.hora_inicio = document.getElementById("txtHoraInicio").value;
                tb_horarios_funcionDTO.nombre_dia = document.getElementById("cboDias").text;
                listahorarios.push(tb_horarios_funcionDTO);
            }
        }
        listahorarios = JSON.stringify({ 'lista': listahorarios });

        console.log(listahorarios);

        $.ajax({
            contentType: 'application/json; charset=utf-8',
            type: "POST",
            dataType: 'json',
            url: "@Url.Action("AgregarHorarioFuncion", "Cartelera")",
            data: listahorarios,
            success: function (data) {
                
                for (var i = 1; i <= 7; i++) {
                    var p = document.getElementById(i);
                    p.innerHTML = "";
                }

                for (var i = 0; i < data.length; i++) {
                    var p = document.getElementById(data[i].id_dia);
                    p.innerHTML = p.innerHTML + '<button class="btn btn-primary" type="button" name="horario" id="' + data[i].hora_inicio+ '_' + data[i].id_dia +'">' + data[i].hora_inicio + '</button>';
                }

             
            },
            error: function (error) {
                console.log(error);
            }
        });
    }
        
        
    
   
</script>